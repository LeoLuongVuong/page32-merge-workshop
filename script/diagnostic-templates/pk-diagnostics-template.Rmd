---
title: "`r paste(params$run, '- Model Diagnostics')`"
output: 
  html_document:
    toc: true
    toc_float: true
    depth: 2
params:
  run: 102
  # These paths should be relative to the top of the project
  modelDir: "model/pk"
  figDir: "deliv/figure"
  yspec: "data/derived/pk.yml"
  # Model details
  contCov: !r c("AGE","WT","ALB","EGFR")
  catCov: !r c("STUDY", "RF", "CP", "DOSE")
  etas: !r c("ETA1//ETA-KA", "ETA2//ETA-V/F", "ETA3//ETA-CL/F")
  drugNameUnits: "concentration (mg/L)"
  include_code: FALSE
  include_plots: TRUE
  run_mrggsave: TRUE
  script: "pk-diagnostics-template.Rmd" # name of this script
---

# Purpose

To produce a set of diagnostic plots that will be included in the report. Please note
that these plots are just meant to provide an example of what could be created and how. 
They are not an exhaustive list of every possible plot and were chosen with the project 
aims in mind. 

While this _should_ give users examples of plots generated with the most up-to-date 
packages and methods, we're always happy to have feedback. If you know of more 
efficient methods or want to suggest alternative ways of plotting the figures 
please open an issue with the details. 


# Set up

```{r setup_general, include = F, message=FALSE, warning = FALSE}
### General script set-up
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE, fig.height = 5, fig.width = 5)

### Libraries ----------------------------
suppressPackageStartupMessages(library(tidyverse)) 
library(pmplots)
library(bbr)
library(mrgmisc)
library(yaml)
library(yspec)
library(mrggsave)
library(here) 
suppressPackageStartupMessages(library(glue))
library(patchwork)

### Directories ----------------------------
figDir <- here(here::here(params$figDir)) 
if(!file.exists(figDir)) dir.create(figDir)

### Options ----------------------------
options(mrg.script = params$script)
margin <- theme(plot.margin = unit(c(0.2, 0.2, 0.1, 0.1), "in"))
parens <-  pmtables::ensure_parens
```


```{r load_any_functions, include = F}
### Source function scripts
source(here('script/functions/functions-diagnostics.R'))
```


```{r setup_bbr, echo = params$include_code, message = FALSE}
# Set directories for bbr models ----------------------------
MODEL_DIR <- params$modelDir
modelName <- params$run
thisModelPath <- file.path(MODEL_DIR, modelName)
shortModelPath <- fs::path_rel(thisModelPath, here::here())
```

### Figure location
If saving figures out to PNG or PDF, define where those files should be saved to.
By default, the figures are saved to ```deliv > figure > model_run_number```

```{r makeDir_mrggsave, echo = params$include_code, eval = params$run_mrggsave}
thisFigDir <- file.path(figDir, modelName)
if(!file.exists(thisFigDir)) dir.create(thisFigDir)

### set mrggsave figure directory here and tell R whether you want the pdf,
## the png or both (e.g.,  mrggsave.dev = "pdf,png")
options(mrggsave.dir = thisFigDir, mrggsave.dev = "png")
```


# Model details - `r shortModelPath`

```{r modelDetails, echo = params$include_code, results = "asis"}
mod <- read_model(here::here(thisModelPath))
mod
```

```{r modelOutputSummary, echo = params$include_code, results = "asis"}
sum <- mod %>% model_summary()
sum
```


# Load Spec
The aim is to use the information in the spec file to label the figures automatically.

```{r yspec_details, echo = params$include_code}
# load in the spec file
spec <- ys_load(here::here(params$yspec)) %>% 
  ys_namespace("plot")
```


# Read in data
Read in the model details using `read_model`. Details stored in the `mod` object can be 
used to identify the location of the source data (used in $DATA) - to see how this is done
look at the `bbr::get_data_path()` and `bbr::build_path_from_model()` helper functions. 

After reading in the nonmem dataset and the output dataset they're joined by a `NUM` column. **This assumes that a row number column (called `NUM`) was included during data assembly.** The idea here is that in NONMEM, you table just `NUM` and none of the other input data items. They all will get joined back to the nonmem output ... even character columns.

The `data` used in the diagnostic plots has been filtered to only include the observations 
(i.e. `EVID==0`). Note that further modifications maybe needed, for example, if BLQ data was 
included in the model or if the `DV` was log-transformed. The dataset also converts
the categorical covariates of interest to factors using the `yspec_add_factors` function 
and details described in the spec file.

The `id` subset gets the first record per ID. This would usually be the baseline value
but consider filtering on a baseline flag if available. Also, if the model includes
inter-occassion variaibility (IOV), the occassion variable should be included within the `distinct` function. 

```{r read_in_data, echo = params$include_code, message=FALSE}

# Get original dataset and nonmem output
data0 <- nm_join(mod)

# filter to observation rows only
data <- data0 %>% 
  filter(EVID==0) %>% 
  ys_factors(spec)
# filter to single row per ID and include factors 
id <- distinct(data, ID, .keep_all=TRUE) 
```


# General diagnostic plots

The following plots assume that the preferred x-axis labels are defined here. 

```{r xAxis_label_names, echo = params$include_code}
### Ideally get units from yaml
xTIME <- glue(pm_axis_time(), xunit = parens(spec$TIME$unit))
xTAD <- glue(pm_axis_tad(), xunit = parens(spec$TAD$unit))
xPRED <-  glue(pm_axis_pred(), xname = params$drugNameUnits)
```

## DV vs PRED and IPRED 

Create plots of DV vs PRED and IPRED for the full dataset and stratified by 
renal function and hepatic function.

```{r DV_PRED_plots, echo = params$include_code, message = FALSE}

dvp <- dv_pred(data, yname = params$drugNameUnits)      # DV vs PRED 
dvip <- dv_ipred(data, yname = params$drugNameUnits)   # DV vs IPRED 

p <- dvp / dvip

# DV vs PRED by renal function
dvp_rf <-  dv_pred(data, yname = params$drugNameUnits, scales="free") +
  facet_wrap(~RF, scales="free") + margin
# DV vs IPRED by renal function
dvip_rf <- dv_ipred(data, yname = params$drugNameUnits, scales="free") + 
  facet_wrap(~RF, scales="free") + margin

# DV vs PRED by hepatic function
dvp_cp <- dv_pred(data, yname = params$drugNameUnits, scales="free") + 
  facet_wrap(~CP, scales="free") + margin
# DV vs IPRED by hepatic function
dvip_cp <- dv_ipred(data, yname = params$drugNameUnits, scales="free") + 
  facet_wrap(~CP, scales="free") + margin

```

```{r include_DV_PRED, eval = params$include_plots, include = params$include_plots, echo = F, message = FALSE}
print("DV vs PRED and IPRED")
p
print("DV vs PRED and IPRED by renal function")
dvp_rf ; dvip_rf
print("DV vs PRED and by hepatic function")
dvp_cp ; dvip_cp
```

```{r save_DV_PRED, include = FALSE, eval = params$run_mrggsave, message = FALSE}
# the stem can be made using c() or glue syntax 
mrggsave(p, 
         stem = "{params$run}-dv-pred-ipred", 
         width = 5, height = 7)

mrggsave(list(dvp_rf, dvip_rf), 
         stem = c(params$run, "dv-pred-ipred-by-rf"), 
         width = 5, height = 5)

mrggsave(list(dvp_cp, dvip_cp), 
         stem = c(params$run, "dv-pred-ipred-by-cp"),
         width = 5, height = 5)
```

```{r rm1, include = F}
rm(p, dvp, dvip, dvp_rf, dvip_rf, dvp_cp, dvip_cp)
```



## NPDE plots


### Combined plot with NPDE vs PRED, time and time after dose and NPDE QQ-plot and density histogram

This code makes a combined plot but alternatives can be generated quickly and easily,
for example, plot NPDE vs time, time after dose, and PRED only using `npde_scatter(data)`
or make just the NPDE histogram and QQ plot with `npde_hist_q`

```{r NPDE_plots_combined, echo = params$include_code, message = FALSE}
p <- npde_panel(data)
```

```{r include_npde_plots_combined, eval = params$include_plots, include = params$include_plots, echo = F, message = FALSE}
p
```

```{r save_npde_plots_combined, include = FALSE, eval = params$run_mrggsave, message = FALSE}
mrggsave(p, stem = c(params$run, "npde-combined"), height = 7)
```

```{r rm_plots_combined, include = F}
rm(p)
```



### NPDE vs continuous covariates

```{r NPDE_cont_cov_plots, echo = params$include_code, message = FALSE}
NPDEco <- spec %>% 
  ys_select(params$contCov) %>%      # select the covariates of interest
  axis_col_labs(title_case = TRUE,   # converts yspec short to title_case 
                short_max = 10)      # if yspec short is >10 characters it keeps the abbreviation

p <- npde_covariate(data, NPDEco)

```

```{r include_NPDE_cont_cov, eval = params$include_plots, include = params$include_plots, echo = F, message = FALSE}
p
```

```{r save_NPDE_cont_cov, include = FALSE, eval = params$run_mrggsave, message = FALSE}

mrggsave(p, stem = c(params$run, "npde-cont-cov"), width = 6, height = 7)

```

```{r rm2_cont_cov, include = F}
rm(p)
```

### NPDE vs categorical covariates

```{r NPDE_cat_cov_plots, echo = params$include_code, message = FALSE}
NPDEca <- spec %>% 
  #ys_select(params$catCov) %>%        # this can be passed in params
  ys_select(c("STUDY", "RF", "CP", "DOSE")) %>%
  axis_col_labs(title_case = TRUE)    # converts yspec short to title_case 

#p <- npde_covariate(data, NPDEca) + 
npde_covariate(data, NPDEca) + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

```

```{r include_NPDE_cat_cov, eval = params$include_plots, include = params$include_plots, echo = F, message = FALSE}
p
```

```{r save_NPDE_cat_cov, include = FALSE, eval = params$run_mrggsave, message = FALSE}

mrggsave(p, stem = c(params$run, "npde-cat-cov"),
         width = 5, height = 7)

```

```{r rm2_cat_cov, include = F}
rm(p, pList)
```

## CWRES plots

### Combined CWRES plots

As with NPDE, other versions of these CWRES plots can be made using functions
like `cwres_scatter()` or `cwres_hist_q`

```{r CWRES_plots_combined, echo = params$include_code, message = FALSE}
p <- cwres_panel(data)
```

```{r include_CWRES_plots_combined, eval = params$include_plots, include = params$include_plots, echo = F, message = FALSE}
p
```

```{r save_CWRES_plots_combined, include = FALSE, eval = params$run_mrggsave, message = FALSE}
mrggsave(p, stem = c(params$run, "cwres-combined"), height = 7)
```

```{r rm_CRWES_plots_combined, include = F}
rm(p)
```





# EBEs-based diagnostics


## ETA pairs plot 

```{r eta_pairs_plots, echo = params$include_code, message = FALSE}
p <- eta_pairs(id, params$etas)
```

```{r include_eta_pairs, eval = params$include_plots, include = params$include_plots, echo = F, message = FALSE}
p
```

```{r save_eta_pairs, include = FALSE, eval = params$run_mrggsave, message = FALSE}
mrggsave(p, stem = c(params$run, "eta-pairs"),
         width = 5, height = 5)
```

```{r rm5, include = F}
rm(p)
```


## Covariate plots

These plots uses the yspec to automatically rename the axis labels.

```{r get_cont_cov_labels, echo = params$include_code}

co <- spec %>% 
  ys_select(params$contCov) %>%     # select the covariates of interest
  axis_col_labs(title_case = TRUE,  # converts yspec short to title_case 
                short_max = 10)     # if yspec short is >10 characters it keeps the abbreviation

ca <- spec %>% 
  ys_select(params$catCov) %>%   # select the covariates of interest
  axis_col_labs(title_case=TRUE)  # converts yspec short to title_case 


p <- eta_covariate(id, x = c(ca, co), y = params$etas)

```

```{r include_eta_vs_cont, eval = params$include_plots, include = params$include_plots, echo = F, message = FALSE}
p
```

```{r save_eta_vs_cont, include = FALSE, eval = params$run_mrggsave, message = FALSE}
mrggsave(p, stem = c(params$run, "eta-all-cont-cov"))
```

```{r rm6, include = F}
rm(p)
```

# Session details

It is considered good practice to include these details at the end of all rmd scripts

```{r details, include = TRUE}
Sys.getenv("AMI_NAME")
sessioninfo::session_info()
bbr::bbi_version()
```

